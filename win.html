<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>¡Victoria!</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
  body { display:flex;align-items:center;justify-content:center;height:100vh;margin:0;padding:2rem;background:linear-gradient(120deg,#0d0c1d,#1a1a2e);color:#f0f8ff;font-family:var(--font-family-base); }
  .card { max-width:1000px;width:100%;padding:2.5rem;border-radius:14px;background:linear-gradient(135deg, rgba(13,12,29,0.95), rgba(26,26,46,0.95));box-shadow:0 12px 48px rgba(0,240,255,0.10); }
  h1 { color:var(--color-accent-primary); text-align:center; font-size:2.6rem; margin-bottom:0.2rem }
  #message { font-size:1.25rem; margin-bottom:0.8rem }
  .summary { display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-bottom:1.2rem }
  .summary .item { background:rgba(255,255,255,0.03);padding:1.2rem 1.4rem;border-radius:10px;min-width:160px;text-align:center; font-size:1.05rem }
  .summary .item .score-highlight { font-size:1.4rem; margin-top:0.4rem }
  .history { margin-top:1rem; max-height:50vh; overflow:auto;border-top:1px solid rgba(255,255,255,0.06); padding-top:1rem }
  .q { padding:1rem;border-bottom:1px solid rgba(255,255,255,0.03); font-size:1.05rem }
  .q.correct { background: rgba(0,255,170,0.03) }
  .q.wrong { background: rgba(255,71,87,0.03) }
  .btn { display:inline-block;padding:1rem 1.6rem;border-radius:12px;background:linear-gradient(90deg,var(--color-accent-primary),var(--color-accent-secondary));color:#051018;font-weight:800;border:none;cursor:pointer;margin-top:1rem;font-size:1.05rem }
  #back-btn { padding:1.1rem 2rem; font-size:1.1rem }
  audio { display:none }
    /* Confetti styles */
    .confetti-container { position:fixed;pointer-events:none;left:0;top:0;width:100%;height:0;overflow:visible;z-index:9999 }
    .confetti {
      position:fixed; width:10px; height:16px; opacity:0.9; transform-origin:center; will-change:transform,opacity; border-radius:2px;
      animation-name:confetti-fall, confetti-tilt; animation-iteration-count:1, infinite; animation-timing-function:linear, ease-in-out;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-10vh) rotate(0deg); opacity:1 }
      100% { transform: translateY(120vh) rotate(720deg); opacity:0.85 }
    }
    @keyframes confetti-tilt {
      0% { transform: translateY(0) rotate(0deg) }
      50% { transform: translateY(10px) rotate(45deg) }
      100% { transform: translateY(0) rotate(0deg) }
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>¡Felicidades!</h1>
    <p id="message" style="text-align:center; font-size:1.1rem; margin-top:0.2rem"></p>
    <div class="summary">
      <div class="item">Jugador: <div id="name" class="score-highlight"></div></div>
      <div class="item">Puntuación: <div id="score" class="score-highlight"></div></div>
      <div class="item">Tiempo: <div id="time" class="score-highlight"></div></div>
      <div class="item">Aciertos: <div id="corrects" class="score-highlight"></div></div>
      <div class="item">Errores: <div id="errors" class="score-highlight"></div></div>
      <div class="item">Comodines usados: <div id="lifelines" class="score-highlight"></div></div>
    </div>

    <div class="history">
      <h3>Historial de preguntas</h3>
      <div id="history-list"></div>
    </div>

    <div style="text-align:center">
      <button id="back-btn" class="btn">Volver al inicio</button>
    </div>

    <audio id="win-audio" src="sound/applause-cheer-236786.mp3" preload="auto"></audio>
  </main>

  <script>
    (function(){
      const resultRaw = localStorage.getItem('quiz_result');
      if (!resultRaw) {
        document.getElementById('message').textContent = 'No se encontró información del juego.';
        return;
      }
      const res = JSON.parse(resultRaw);
      document.getElementById('name').textContent = res.name || 'Jugador';
      document.getElementById('score').textContent = res.score ?? 0;
      document.getElementById('time').textContent = (res.totalTime != null) ? (res.totalTime + 's') : '-';
      document.getElementById('corrects').textContent = res.correctAnswers ?? 0;
      document.getElementById('errors').textContent = res.errors ?? 0;
      const lif = res.lifelinesUsed || {};
      const lifText = Object.keys(lif).map(k => `${k}: ${lif[k] ? 'Sí' : 'No'}`).join(' | ');
      document.getElementById('lifelines').textContent = lifText || '-';

      const listEl = document.getElementById('history-list');
      if (Array.isArray(res.history) && res.history.length) {
        res.history.forEach((h, i) => {
          const div = document.createElement('div');
          div.className = 'q ' + (h.correct ? 'correct' : 'wrong');
          div.innerHTML = `<strong>Q${i+1}:</strong> ${h.text} <br>
            Tu respuesta: <em>${h.chosenText}</em> ${h.correct ? '<span style="color:var(--color-accent-primary)">✔</span>' : '<span style="color:var(--color-error)">✖</span>'} <br>
            Respuesta correcta: <em>${h.correctText}</em> <br>
            Tiempo: ${h.timeTaken}s ${h.usedDouble ? ' | Duplicador usado' : ''}
          `;
          listEl.appendChild(div);
        });
      } else {
        listEl.innerHTML = '<p>No hay historial de preguntas.</p>';
      }

      const audio = document.getElementById('win-audio');
      // reproducir respetando la preferencia de mute guardada en start page (si existe)
      try {
        const mutePref = localStorage.getItem('quiz_mute');
        if (mutePref === 'true') {
          audio.muted = true;
        }
      } catch (e) {}

      // Crear contenedor de confetti
      const confettiContainer = document.createElement('div');
      confettiContainer.className = 'confetti-container';
      document.body.appendChild(confettiContainer);

      function createConfetti(count = 70) {
        const colors = ['#FF3B30','#FF9500','#FFCC00','#4CD964','#5AC8FA','#5856D6','#FF2D55'];
        const w = window.innerWidth;
        for (let i = 0; i < count; i++) {
          const el = document.createElement('div');
          el.className = 'confetti';
          const color = colors[Math.floor(Math.random() * colors.length)];
          el.style.background = color;
          const left = Math.random() * w;
          el.style.left = (left - 10) + 'px';
          const delay = Math.random() * 0.5;
          const duration = 2 + Math.random() * 2.5;
          el.style.top = '-10vh';
          el.style.opacity = 0.95;
          el.style.transform = `rotate(${Math.random()*360}deg)`;
          el.style.animationDuration = `${duration}s, ${0.8 + Math.random()*1.2}s`;
          el.style.animationDelay = `${delay}s, 0s`;
          confettiContainer.appendChild(el);
          // remover después de animar
          setTimeout(() => { try{ confettiContainer.removeChild(el); }catch(e){} }, (duration + 0.6) * 1000 + delay*1000);
        }
      }

      // Intentar reproducir; algunos navegadores bloquean autoplay sin interacción
      audio.play().then(() => {
        // si reproduce, lanzar confetti
        createConfetti(90);
      }).catch(() => {
        // Si falla, mostrar un botón para reproducir y activar confetti al pulsarlo
        const playBtn = document.createElement('button');
        playBtn.className = 'btn';
        playBtn.textContent = 'Reproducir aplausos';
        playBtn.addEventListener('click', () => {
          audio.play().then(() => createConfetti(90));
        });
        document.querySelector('main').appendChild(playBtn);
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        // limpiar el resultado y volver al inicio
        try { localStorage.removeItem('quiz_result'); } catch (e) {}
        window.location.href = 'index.html';
      });
    })();
  </script>
</body>
</html>